
<!DOCTYPE html>
<html lang="de">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dienstzeiten-Rechner inkl. 1/6-Regel</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    :root {
      --primary: #0d6efd;
      --secondary: #f8f9fa;
      --text: #212529;
      --border-radius: 10px;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--secondary); color: var(--text); }
    input { width: 70px; padding: 6px; margin: 2px; border-radius: 4px; border: 1px solid #ccc; }
    label { display: inline-block; width: 180px; margin-top: 10px; }
    .box { background: white; padding: 30px; border-radius: var(--border-radius); max-width: 650px; margin: 40px auto; box-shadow: var(--shadow); }
    h2 { text-align: center; color: var(--primary); margin-bottom: 20px; }
    button { margin-top: 12px; padding: 10px 20px; margin-right: 10px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; } button:hover { background: #0b5ed7; }
    .result { margin-top: 20px; font-weight: bold; }
    .section { margin-top: 15px; }
    .signature { margin-top: 40px; font-style: italic; text-align: right; color: #6c757d; }
  </style>
</head>
<body>
  <div class="box">
    <h2>Dienstzeiten-Rechner inkl. 1/6-Regel</h2>
    <div>
      <label>Dienstbeginn:</label><input id="start" type="time" value="05:12"><br>
      <label>Dienstende:</label><input id="end" type="time" value="13:48"><br>
      <label>Pause (min):</label><input id="pause" type="number" value="0"><br>

      <div class="section">
        <label>Standzeiten (max. 12):</label><br>
        <div id="standzeiten"></div>
      </div>

      <div class="section">
        <label>Wendezeiten (max. 12):</label><br>
        <div id="wendezeiten"></div>
      </div>

      <button onclick="berechnen()">Berechnen</button>
      <button onclick="exportPDF()">PDF Export</button>
    </div>
    <div class="result" id="output-box">
      <div id="output"></div>
      <div class="signature">
        ____________________________<br>
        Jörg Ziegler<br>
        16.06.2025
      </div>
    </div>
  </div>

  <script>
    function createInputs(containerId, className) {
      const container = document.getElementById(containerId);
      for (let i = 0; i < 12; i++) {
        const input = document.createElement("input");
        input.type = "number";
        input.className = className;
        input.placeholder = (i + 1);
        container.appendChild(input);
      }
    }

    createInputs("standzeiten", "stand");
    createInputs("wendezeiten", "wende");

    
    function berechnen() {
      const now = new Date();
      const datum = now.toLocaleDateString('de-DE');
      const zeit = now.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
    
      const toMinutes = t => {
        let [h, m] = t.split(":").map(Number);
        return h * 60 + m;
      };

      const sumInputs = className => {
        return Array.from(document.getElementsByClassName(className))
          .map(input => Number(input.value) || 0)
          .reduce((a, b) => a + b, 0);
      };

      let start = toMinutes(document.getElementById("start").value);
      let end = toMinutes(document.getElementById("end").value);
      let pause = Number(document.getElementById("pause").value);
      let stand = sumInputs("stand");
      let wendezeiten = Array.from(document.getElementsByClassName("wende"))
        .map(input => Number(input.value) || 0);

      let wende = wendezeiten.reduce((a, b) => a + b, 0);
      let arbeitszeit = end - start - pause;
      let lenkzeit = arbeitszeit - stand - wende;

      function toHHMM(min) {
        let h = Math.floor(min / 60);
        let m = min % 60;
        return `${h.toString().padStart(2, "0")}:${m.toString().padStart(2, "0")} h`;
      }

      // Prüfung der 1/6-Regel: nur Wendezeiten >= 11 min (10 + 1 techn. Minute) zählen
      let anrechenbareWenden = wendezeiten.filter(min => min >= 11).reduce((a, b) => a + b, 0);
      let mindestpause161 = Math.ceil(lenkzeit / 6);

      let hinweis = "";
      
    
    if (lenkzeit > 270) {
        if (pause >= 30) {
            hinweis = "<br><span style='color:green;'>✔️ Keine Verstöße erkannt – klassische Pause ausreichend (≥ 45 Min).</span>";
        } else if (pause >= 30) {
            hinweis = "<br><span style='color:green;'>✔️ Keine Verstöße erkannt – Pause über 30 Minuten ausreichend laut Ausnahme-Regel.</span>";
        } else if (anrechenbareWenden >= mindestpause161) {
            hinweis = "<br><span style='color:orange;'>⚠️ Keine klassische Pause, aber ausreichend anrechenbare Wendezeiten laut 1/6-Regel (" + anrechenbareWenden + " min von mindestens " + mindestpause161 + " min)</span>";
        } else {
            hinweis = "<br><span style='color:red;'>❌ Verstoß: Lenkzeit über 4:30h ohne ausreichende Pause – auch Wendezeitregel ungenügend!</span>";
        }
    } else {
        hinweis = "<br><span style='color:green;'>✔️ Keine Verstöße erkannt.</span>";
    }

        if (pause >= 30) {
            hinweis = "<br><span style='color:green;'>✔️ Keine Verstöße erkannt – Pause über 30 Minuten ausreichend.</span>";
        } else if (anrechenbareWenden >= mindestpause161) {
            hinweis = "<br><span style='color:orange;'>⚠️ Keine klassische Pause, aber ausreichend anrechenbare Wendezeiten laut 1/6-Regel (" + anrechenbareWenden + " min von mindestens " + mindestpause161 + " min)</span>";
        } else {
            hinweis = "<br><span style='color:red;'>❌ Verstoß: Lenkzeit über 4:30h ohne ausreichende Pause – auch Wendezeitregel ungenügend!</span>";
        }
    } else {
        hinweis = "<br><span style='color:green;'>✔️ Keine Verstöße erkannt.</span>";
    }

        if (anrechenbareWenden >= mindestpause161) {
          hinweis = "<br><span style='color:orange;'>⚠️ Keine klassische Pause, aber ausreichend anrechenbare Wendezeiten laut 1/6-Regel (" + anrechenbareWenden + " min von mindestens " + mindestpause161 + " min)</span>";
        } else {
          hinweis = "<br><span style='color:red;'>❌ Verstoß: Lenkzeit über 4:30h ohne ausreichende Pause – auch Wendezeitregel ungenügend!</span>";
        }
      } else {
        hinweis = "<br><span style='color:green;'>✔️ Keine Verstöße erkannt.</span>";
      }

      
    const ergebnisHTML = `
    Dienstbeginn: ${document.getElementById("start").value}<br>
    Dienstende: ${document.getElementById("end").value}<br>
    Pause: ${pause} Minuten<br><br>
    Arbeitszeit: ${toHHMM(arbeitszeit)}<br>
    Lenkzeit: ${toHHMM(lenkzeit)}<br>
    Standzeit (gesamt): ${toHHMM(stand)}<br>
    Wendezeit (gesamt): ${toHHMM(wende)}${hinweis}
    `;

    document.getElementById("output").innerHTML = ergebnisHTML;

    const eintrag = {
      zeitpunkt: datum + " " + zeit,
      beginn: document.getElementById("start").value,
      ende: document.getElementById("end").value,
      pause,
      arbeitszeit: toHHMM(arbeitszeit),
      lenkzeit: toHHMM(lenkzeit),
      standzeit: toHHMM(stand),
      wendezeit: toHHMM(wende),
      hinweis: hinweis.replace(/<[^>]*>?/gm, '') // HTML-Tags entfernen
    };

    let verlauf = JSON.parse(localStorage.getItem("dienstzeitenVerlauf")) || [];
    verlauf.unshift(eintrag);
    if (verlauf.length > 20) verlauf = verlauf.slice(0, 20); // max 20 Einträge
    localStorage.setItem("dienstzeitenVerlauf", JSON.stringify(verlauf));
    anzeigenVerlauf();
    
        Dienstbeginn: ${document.getElementById("start").value}<br>
        Dienstende: ${document.getElementById("end").value}<br>
        Pause: ${pause} Minuten<br><br>
        Arbeitszeit: ${toHHMM(arbeitszeit)}<br>
        Lenkzeit: ${toHHMM(lenkzeit)}<br>
        Standzeit (gesamt): ${toHHMM(stand)}<br>
        Wendezeit (gesamt): ${toHHMM(wende)}${hinweis}
      `;
    }

    
    
    function anzeigenVerlauf() {
      const filter = document.getElementById("filter")?.value || "";
      const verlauf = JSON.parse(localStorage.getItem("dienstzeitenVerlauf")) || [];
      const list = verlauf
        .filter(e => !filter || e.hinweis.includes(filter))
        .map(e => `
          <div style="margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px;">
            <strong>${e.zeitpunkt}</strong><br>
            Dienst: ${e.beginn} – ${e.ende}, Pause: ${e.pause} min<br>
            AZ: ${e.arbeitszeit}, LZ: ${e.lenkzeit}, ST: ${e.standzeit}, WT: ${e.wendezeit}<br>
            Bewertung: ${e.hinweis}
          </div>
        `).join('');
      document.getElementById("history-list").innerHTML = list || "<em>Keine gespeicherten Einträge.</em>";
    }

    function exportCSV() {
      const verlauf = JSON.parse(localStorage.getItem("dienstzeitenVerlauf")) || [];
      if (verlauf.length === 0) return alert("Kein Verlauf vorhanden.");
      const csv = [
        ["Zeitpunkt", "Beginn", "Ende", "Pause", "Arbeitszeit", "Lenkzeit", "Standzeit", "Wendezeit", "Bewertung"],
        ...verlauf.map(e => [e.zeitpunkt, e.beginn, e.ende, e.pause, e.arbeitszeit, e.lenkzeit, e.standzeit, e.wendezeit, e.hinweis])
      ].map(row => row.map(field => `"${field}"`).join(",")).join("\n");

      const blob = new Blob([csv], {{ type: 'text/csv' }});
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "dienstzeiten_verlauf.csv";
      link.click();
    }

    function exportHistoryPDF() {
      const verlauf = JSON.parse(localStorage.getItem("dienstzeitenVerlauf")) || [];
      if (verlauf.length === 0) return alert("Kein Verlauf vorhanden.");

      const content = verlauf.map(e => `
        <div style='margin-bottom: 10px;'>
          <strong>${e.zeitpunkt}</strong><br>
          Dienst: ${e.beginn} – ${e.ende}, Pause: ${e.pause} min<br>
          AZ: ${e.arbeitszeit}, LZ: ${e.lenkzeit}, ST: ${e.standzeit}, WT: ${e.wendezeit}<br>
          Bewertung: ${e.hinweis}
        </div>`).join('');

      const container = document.createElement("div");
      container.innerHTML = `<h3>Dienstzeiten Verlauf</h3>${content}`;
      html2pdf().from(container).set({{
        margin: 0.5,
        filename: 'dienstzeiten_verlauf.pdf',
        image: {{ type: 'jpeg', quality: 0.98 }},
        html2canvas: {{ scale: 2 }},
        jsPDF: {{ unit: 'in', format: 'a4', orientation: 'portrait' }}
      }}).save();
    }

      const verlauf = JSON.parse(localStorage.getItem("dienstzeitenVerlauf")) || [];
      const list = verlauf.map(e => `
        <div style="margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px;">
          <strong>${e.zeitpunkt}</strong><br>
          Dienst: ${e.beginn} – ${e.ende}, Pause: ${e.pause} min<br>
          AZ: ${e.arbeitszeit}, LZ: ${e.lenkzeit}, ST: ${e.standzeit}, WT: ${e.wendezeit}<br>
          Bewertung: ${e.hinweis}
        </div>
      `).join('');
      document.getElementById("history-list").innerHTML = list || "<em>Keine gespeicherten Einträge.</em>";
    }

    function clearHistory() {
      localStorage.removeItem("dienstzeitenVerlauf");
      anzeigenVerlauf();
    }

    window.onload = anzeigenVerlauf;

    function exportPDF() {

      const element = document.getElementById("output-box");
      const opt = {
        margin:       0.5,
        filename:     'Dienstzeiten_Ergebnis.pdf',
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2 },
        jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
      };
      html2pdf().from(element).set(opt).save();
    }
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(reg => console.log('Service Worker registriert:', reg.scope))
          .catch(err => console.log('Service Worker Fehler:', err));
      });
    }
  </script>
</body>
</html>
